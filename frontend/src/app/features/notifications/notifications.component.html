<div class="notification-wrapper">
  <button class="notification-bell" (click)="toggleDropdown()" aria-haspopup="dialog"
    [attr.aria-expanded]="showDropdown">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor">
      <path
        d="M8 16a2 2 0 0 0 1.985-1.75H6.015A2 2 0 0 0 8 16zm.104-14a4.002 4.002 0 0 1 3.978 3.001c.12.388.23.833.327 1.342.14.688.21 1.293.21 1.92v2.5l.9 1.2a.5.5 0 0 1-.4.8H3.861a.5.5 0 0 1-.4-.8l.9-1.2v-2.5c0-.627.07-1.232.21-1.92.097-.509.207-.954.327-1.342A4.002 4.002 0 0 1 7.896 2z" />
    </svg>
    <span class="badge" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
  </button>
</div>

<!-- Inline version if host container is not defined -->
<ng-container *ngIf="showDropdown && !inlineHost">
  <ng-container *ngTemplateOutlet="panelTemplate; context: dropdownContext"></ng-container>
</ng-container>

<ng-template #panelTemplate let-inline="inline">
  <div class="notifications-panel" [class.notifications-dropdown]="!inline" [class.notifications-inline]="inline"
    [attr.role]="inline ? 'region' : 'dialog'" [attr.aria-label]="inline ? null : 'Notifications panel'">
    <div class="panel-header">
      <div class="tabs">
        <div class="tab active">Messages ({{ unreads.length || 0 }})</div>
        <div class="tab">Requests ({{ pendingRequests.length || 0 }})</div>
      </div>
      <button class="mark-read" *ngIf="unreads.length" (click)="markAllAsRead()" aria-label="Mark all as read">
        Mark all read
      </button>
    </div>

    <!-- Recent chat messages -->
    <div class="section" *ngIf="unreads.length">
      <div class="section-title">Recent messages</div>
      <div *ngFor="let msg of unreads" class="notification-item" (click)="userClicked(msg.SenderId)">
        <img [src]="msg.ProfilePicture" alt="avatar" class="avatar" />
        <div class="message-info">
          <div class="sender">{{ msg.SenderUsername }}</div>
          <div class="content">{{ msg.Content }}</div>
          <div class="content timestamp">{{ msg.Timestamp | date: 'short' }}</div>
        </div>
      </div>
    </div>

    <!-- Non-reactive friend requests -->
    <div class="section" *ngIf="pendingRequests.length">
      <div class="section-title">Friend requests</div>
      <div *ngFor="let req of pendingRequests" class="notification-item">
        <img [src]="req.SenderPicture || '/assets/svg/user-avatar-placeholder.svg'" alt="avatar" class="avatar" />

        <!-- Pending request -->
        <div *ngIf="req.Status === 'PENDING' || !req.Status" class="message-info">
          <div class="sender">{{ req.SenderUsername }}</div>
          <div class="content">sent you a friend request</div>
          <div class="friend-actions">
            <button class="btn btn-success btn-sm" (click)="acceptRequest(req.SenderId)">Accept</button>
            <button class="btn btn-danger btn-sm" (click)="declineRequest(req.SenderId)">Decline</button>
          </div>
        </div>

        <!-- Accepted request -->
        <div *ngIf="req.Status === 'ACCEPTED'" class="message-info">
          <div class="sender">{{ req.SenderUsername }}</div>
          <div class="content">accepted your friend request</div>
          <div class="friend-actions">
            <button class="btn btn-success btn-sm" (click)="clearRequest(req.SenderId)">Clear</button>
          </div>
        </div>

        <!-- Declined request -->
        <div *ngIf="req.Status === 'DECLINED'" class="message-info">
          <div class="sender">{{ req.SenderUsername }}</div>
          <div class="content">declined your friend request</div>
          <div class="friend-actions">
            <button class="btn btn-success btn-sm" (click)="clearRequest(req.SenderId)">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Reactive WebSocket notifications for chat messages -->
    <div *ngFor="let notification of notifications">
      <div *ngIf="notification.type === 'newMessage'" class="notification-item"
        (click)="userClicked(notification.senderId)">
        <img [src]="notification.profilePicture" alt="avatar" class="avatar" />
        <div class="message-info">
          <div class="sender">{{ notification.senderUsername }}</div>
          <div class="content">{{ notification.content }}</div>
          <div class="content">{{ notification.timestamp | date: 'short' }}</div>
        </div>
      </div>
    </div>

    <!-- Reactive WebSocket notifications for friend requests -->
    <div *ngFor="let notification of notifications">
      <div *ngIf="
          notification.type === 'friend_request' ||
          notification.type === 'friend_request_accepted' ||
          notification.type === 'friend_request_declined'
        " class="notification-item">
        <img [src]="notification.fromPicture || '/assets/svg/user-avatar-placeholder.svg'" alt="avatar"
          class="avatar" />
        <div class="message-info">
          <div class="content">{{ notification.message }}</div>

          <!-- Pending friend request actions -->
          <div *ngIf="notification.type === 'friend_request'" class="friend-actions">
            <button class="btn btn-success btn-sm"
              (click)="acceptRequest(notification.fromUserId); clearRequest(notification.fromUserId)">
              Accept
            </button>
            <button class="btn btn-danger btn-sm"
              (click)="declineRequest(notification.fromUserId); clearRequest(notification.fromUserId)">
              Decline
            </button>
          </div>

          <!-- Accepted or declined friend request -->
          <div *ngIf="
              notification.type === 'friend_request_accepted' ||
              notification.type === 'friend_request_declined'
            " class="friend-actions">
            <button class="btn btn-success btn-sm" (click)="clearRequest(notification.fromUserId)">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <!-- No notifications -->
    <div *ngIf="unreads.length === 0 && pendingRequests.length === 0 && notifications.length === 0" class="empty-msg">
      No notifications
    </div>
  </div>
</ng-template>