<div class="notification-wrapper">
  <button class="notification-bell" (click)="toggleDropdown()" aria-haspopup="dialog"
    [attr.aria-expanded]="showDropdown">
    <!-- Bell Icon -->
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor">
      <path
        d="M8 16a2 2 0 0 0 1.985-1.75H6.015A2 2 0 0 0 8 16zm.104-14a4.002 4.002 0 0 1 3.978 3.001c.12.388.23.833.327 1.342.14.688.21 1.293.21 1.92v2.5l.9 1.2a.5.5 0 0 1-.4.8H3.861a.5.5 0 0 1-.4-.8l.9-1.2v-2.5c0-.627.07-1.232.21-1.92.097-.509.207-.954.327-1.342A4.002 4.002 0 0 1 7.896 2z" />
    </svg>

    @if (totalCount$ | async; as totalCount) {
    <span class="badge">
      {{ totalCount }}
    </span>
    }
  </button>
</div>

@if (showDropdown && !inlineHost) {
<ng-container *ngTemplateOutlet="panelTemplate; context: dropdownContext"></ng-container>
}


<ng-template #panelTemplate let-inline="inline">
  <div class="notifications-panel" [class.notifications-dropdown]="!inline" [class.notifications-inline]="inline"
    [attr.role]="inline ? 'region' : 'dialog'" [attr.aria-label]="inline ? null : 'Notifications panel'">
    <div class="panel-header">
      <div class="tabs" role="tablist">
        <!-- Messages Tab -->
        <button type="button" class="tab tab-messages" role="tab" [class.active]="activeTab === 'messages'"
          [attr.aria-selected]="activeTab === 'messages'" (click)="setActiveTab('messages', $event)"
          [attr.aria-label]="'Messages (' + (messages$ | async)?.length + ')'">
          <span class="tab-main">
            <span class="tab-icon" aria-hidden="true">
              <svg viewBox="0 0 20 20" class="icon-envelope">
                <rect x="3" y="6.5" width="14" height="9" rx="2" class="envelope-body"></rect>
                <path d="M3 7l7 5.5L17 7" class="envelope-fold"></path>
                <path d="M3 7l7-4 7 4" class="envelope-flap"></path>
              </svg>
            </span>
            <span class="tab-label">Messages</span>
          </span>
          @if (totalCount$ | async; as totalCount) {
          <span class="tab-count">
            {{ (messages$ | async)?.length }}
          </span>
          }
        </button>
        <button type="button" class="tab tab-requests" role="tab" [class.active]="activeTab === 'requests'"
          [attr.aria-selected]="activeTab === 'requests'" (click)="setActiveTab('requests', $event)"
          [attr.aria-label]="'Requests (' + (friendRequests$ | async)?.length+ ')'">
          <span class="tab-main">
            <span class="tab-icon" aria-hidden="true">
              <svg viewBox="0 0 20 20" class="icon-profile">
                <circle cx="10" cy="7" r="3" class="profile-head"></circle>
                <path d="M4 16c0-3 2.5-5 6-5s6 2 6 5v1H4z" class="profile-body-fill"></path>
                <path d="M4 16c0-3 2.5-5 6-5s6 2 6 5" class="profile-body-line"></path>
              </svg>
            </span>
            <span class="tab-label">Requests</span>
          </span>
          <span class="tab-count" aria-hidden="true">
            {{ (friendRequests$ | async)?.length }}
          </span>
        </button>
      </div>

      <!-- Top Action Button (Messages) -->
      @if (activeTab === 'messages' && (messages$ | async)?.length) {
      <button class="mark-read icon-toggle" (click)="markAllAsRead()"
        [attr.aria-label]="'Mark all as read (' + (messages$ | async)?.length + ')'">
        <span class="icon-wrapper" aria-hidden="true">
          <svg viewBox="0 0 20 20" class="icon-trash">
            <path d="M6 6v8c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2V6" class="trash-body" />
            <path d="M4 6h12" class="trash-lid" />
            <path d="M8 6V4h4v2" class="trash-handle" />
          </svg>
        </span>
      </button>
      }


      <!-- Top Action Button (Requests) -->
      @if (activeTab === 'requests' && (friendRequests$ | async)?.length) {
      <button class="mark-read icon-toggle" (click)="markRequestsAsRead()"
        [attr.aria-label]="'Mark all as read (' + (friendRequests$ | async)?.length + ')'">
        <span class="icon-wrapper" aria-hidden="true">
          <svg viewBox="0 0 20 20" class="icon-trash">
            <path d="M6 6v8c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2V6" class="trash-body" />
            <path d="M4 6h12" class="trash-lid" />
            <path d="M8 6V4h4v2" class="trash-handle" />
          </svg>
        </span>
      </button>
      }

    </div>

    <div class="panel-body">
      <!-- Messages Section -->
      @if (activeTab === 'messages') {
      <div class="section">
        @if ((messages$ | async)?.length) {
        @for (msg of messages$ | async; track msg.roomId) {
        <div class="notification-item" (click)="userClicked(msg.roomId)">
          <img [src]="msg.profilePicture || '/assets/svg/user-avatar-placeholder.svg'" alt="avatar" class="avatar" />

          <div class="message-info">
            <div class="sender">{{ msg.senderUsername }}</div>
            <div class="content">{{ msg.content }}</div>
            <div class="content timestamp">
              {{ msg.timestamp | date: 'short' }}
            </div>
          </div>
        </div>
        }
        } @else {
        <div class="empty-msg">No messages</div>
        }
      </div>
      }


      <!-- Requests Section -->
      @if (activeTab === 'requests') {
      <div class="section">
        @if ((friendRequests$ | async)?.length) {
        @for (req of friendRequests$ | async; track req.fromUserId) {
        <div class="notification-item friend-request">
          <img [src]="req.senderPicture || '/assets/svg/user-avatar-placeholder.svg'" alt="avatar" class="avatar" />

          <div class="message-info">
            <div class="sender">{{ req.fromUsername }}</div>

            <!-- Status Output -->
            @if (req.status === 'PENDING') {
            <div class="content">sent you a friend request</div>
            }
            @if (req.status === 'ACCEPTED') {
            <div class="content">accepted your friend request</div>
            }
            @if (req.status === 'DECLINED') {
            <div class="content">declined your friend request</div>
            }

            <!-- Actions -->
            @if (req.status === 'PENDING') {
            <div class="friend-actions">
              <app-button label="Accept" size="xsmall" variant="highlight" (click)="acceptRequest(req.fromUserId)">
              </app-button>
              <app-button label="Decline" size="xsmall" (click)="declineRequest(req.fromUserId)">
              </app-button>
            </div>
            }

            @if (req.status === 'ACCEPTED' || req.status === 'DECLINED') {
            <div class="friend-actions">
              <app-button label="Clear" size="xsmall" variant="highlight" (click)="clearRequest(req.fromUserId)">
              </app-button>
            </div>
            }
          </div>
        </div>
        }
        } @else {
        <p>No friend requests</p>
        }
      </div>
      }

      <ng-template #noRequests>
        <div class="empty-msg">No friend requests</div>
      </ng-template>
    </div>
  </div>
</ng-template>